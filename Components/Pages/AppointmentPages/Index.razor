@page "/appointments"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using SpaAndBeautyWebsite.Models
@using SpaAndBeautyWebsite.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@implements IAsyncDisposable
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Policy = "CustomersOrAbove")]

<PageTitle>Appointments</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Appointments</h1>
    <a href="appointments/create" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Create New
    </a>
</div>

<QuickGrid Class="table table-striped table-hover table-bordered align-middle"
           Items="items"
           RowClass="@GetRowClass">

    <PropertyColumn Property="@(p => p.EmployeeName)" Title="Employee" Sortable="true" />
    <PropertyColumn Property="@(p => p.CustomerName)" Title="Customer" Sortable="true" />
    <PropertyColumn Property="@(p => p.ServiceName)" Title="Service" Sortable="true" />
    <PropertyColumn Property="@(p => p.ScheduledDateTime)" Title="Date & Time" Format="g" Sortable="true" />
    <PropertyColumn Property="@(p => p.DurationMinutes)" Title="Duration (m)" Sortable="true" Class="text-center" />
    <PropertyColumn Property="@(p => p.Notes)" Title="Customer Notes"/>

    <TemplateColumn Title="Status" Sortable="true">
        @switch (context.Status)
        {
            case "Completed":
                <span class="badge bg-success">Completed</span>
                break;
            case "No Show":
                <span class="badge bg-danger">No Show</span>
                break;
            case "Checked In":
                <span class="badge bg-info text-dark">Checked In</span>
                break;
            case "In Progress":
                <span class="badge bg-warning text-dark">In Progress</span>
                break;
            default:
                <span class="badge bg-primary">@context.Status</span>
                break;
        }
    </TemplateColumn>

    <TemplateColumn Title="Actions">
        <div class="d-flex gap-2">
            @if (context.Status != "Completed" && context.Status != "No Show" && context.Status != "Cancelled")
            {
                <a href="@($"appointments/edit?appointmentid={context.AppointmentId}")" class="btn btn-sm btn-outline-primary">
                    Edit
                </a>
                <a href="@($"appointments/delete?appointmentid={context.AppointmentId}")" class="btn btn-sm btn-outline-danger">
                    Delete
                </a>
            }
            @if (userRole == "Admin")
            {
                <a href="@($"appointments/details?appointmentid={context.AppointmentId}")" class="btn btn-sm btn-outline-warning">
                    Details
                </a>
            }
        </div>
    </TemplateColumn>

</QuickGrid>

    @code {
    private SpaAndBeautyWebsiteContext context = default!;
    private IQueryable<AppointmentViewModel> items = default!;
    private string userRole ="";

    private string GetRowClass(AppointmentViewModel appointment)
    {
        if (appointment.Status == "Completed" || appointment.Status == "No Show" || appointment.Status == "Cancelled")
        {
            return "row-inactive";
        }
        return "";
    }

    public class AppointmentViewModel
    {
        public int AppointmentId { get; set; }
        public string EmployeeName { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public string ServiceName { get; set; } = "";
        public DateTime ScheduledDateTime { get; set; }
        public int DurationMinutes { get; set; }
        public string? Status { get; set; }
        public string? Notes { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var currentUsername = user.Identity?.Name ?? "";

        IQueryable<Appointment> appointmentBaseQuery = context.Appointment.Where(a => false);

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            // Admin and Manager get FULL access
            if (user.IsInRole("Admin") || user.IsInRole("Manager"))
            {
                userRole = "Admin";
                appointmentBaseQuery = context.Appointment;
            }
            // Staff get RESTRICTED access
            else if (user.IsInRole("Staff"))
            {
                // Look up the specific Staff member in the Employee table
                var currentEmployee = await context.Employee
                    .FirstOrDefaultAsync(e => e.Username == currentUsername);

                if (currentEmployee != null)
                {
                    appointmentBaseQuery = context.Appointment
                        .Where(a => a.EmployeeId == currentEmployee.EmployeeId);
                }
            }
            // Customers get RESTRICTED access
            else if (user.IsInRole("Customer"))
            {
                var currentCustomer = await context.Customer
                    .FirstOrDefaultAsync(c => c.Username == currentUsername);

                if (currentCustomer != null)
                {
                    appointmentBaseQuery = context.Appointment
                        .Where(a => a.CustomerId == currentCustomer.CustomerId);
                }
            }
        }

        var query = from a in appointmentBaseQuery
                    join e in context.Employee on a.EmployeeId equals e.EmployeeId into eGroup
                    from e in eGroup.DefaultIfEmpty()
                    join c in context.Customer on a.CustomerId equals c.CustomerId into cGroup
                    from c in cGroup.DefaultIfEmpty()
                    join s in context.Service on a.ServiceId equals s.ServiceId into sGroup
                    from s in sGroup.DefaultIfEmpty()
                    select new AppointmentViewModel
                    {
                        AppointmentId = a.AppointmentId,
                        EmployeeName = e != null ? e.FirstName + " " + e.LastName : "Unknown Employee",
                        CustomerName = c != null ? c.FirstName + " " + c.LastName : "Unknown Customer",
                        ServiceName = s != null ? s.Name : "Unknown Service",
                        ScheduledDateTime = a.ScheduledDateTime,
                        DurationMinutes = a.DurationMinutes,
                        Status = a.Status,
                        Notes = a.Notes
                    };

        items = query
            .OrderBy(x => x.Status == "Scheduled" ? 1 :
                x.Status == "Checked In" ? 2 :
                x.Status == "In Progress" ? 3 :
                x.Status == "Completed" ? 4 :
                5)
            .ThenBy(x => x.ScheduledDateTime);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
